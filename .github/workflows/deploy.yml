name: Prod Deploy
on:
  # Auto-deploy after CI passes on main. Storybook runs in parallel — we gate
  # on it inside the job rather than using a second workflow_run trigger (which
  # would fire on either workflow completing, not both).
  workflow_run:
    workflows: [Main]
    branches: [main]
    types: [completed]
  # Manual trigger (e.g. first deploy after infra:setup + infra:sync:github)
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false  # never cancel an in-flight production deploy

jobs:
  deploy:
    name: Deploy to Vercel Production
    # Skip if triggered by workflow_run that failed
    if: >
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_TELEMETRY_DISABLED: 1

    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js & Install Dependencies
        uses: ./.github/actions/bootstrap

      - name: Setup Turso CLI
        uses: ./.github/actions/setup-turso

      - name: Restore/Save Next.js build cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('src/**') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: Pull Vercel environment (production)
        run: ./node_modules/.bin/vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Push database credentials to Vercel production
        # GitHub Secrets are the single source of truth for DB credentials.
        # We push them fresh on every deploy so Vercel always has the current values.
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_AUTH_TOKEN: ${{ secrets.DATABASE_AUTH_TOKEN }}
        run: |
          printf '%s' "$DATABASE_URL" | \
            ./node_modules/.bin/vercel env add DATABASE_URL production --force --token=${{ secrets.VERCEL_TOKEN }}
          printf '%s' "$DATABASE_AUTH_TOKEN" | \
            ./node_modules/.bin/vercel env add DATABASE_AUTH_TOKEN production --force --sensitive --token=${{ secrets.VERCEL_TOKEN }}

      - name: Snapshot database before migration
        # Captures the pre-migration state as a SQL dump so it can be replayed
        # locally if a destructive migration needs to be rolled back.
        env:
          TURSO_API_TOKEN: ${{ secrets.TURSO_API_TOKEN }}
          TURSO_DB_NAME: ${{ vars.TURSO_DB_NAME }}
        run: turso db shell "$TURSO_DB_NAME" ".dump" > "db-snapshot-${{ github.sha }}.sql"

      - name: Upload database snapshot
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: db-snapshot-${{ github.sha }}
          path: db-snapshot-${{ github.sha }}.sql
          retention-days: 30

      - name: Run database migrations
        # No-op when schema is unchanged. --force skips the interactive data-loss
        # prompt so destructive migrations (drop column/table) apply automatically.
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_AUTH_TOKEN: ${{ secrets.DATABASE_AUTH_TOKEN }}
        run: ./node_modules/.bin/drizzle-kit push --force

      - name: Build project
        # Sensitive env vars are not returned by `vercel pull`, so inject them
        # explicitly here so the build can reach the database.
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_AUTH_TOKEN: ${{ secrets.DATABASE_AUTH_TOKEN }}
        run: ./node_modules/.bin/vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          url=$(./node_modules/.bin/vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} --yes)
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: Health check
        # Retry for up to 2 minutes — Vercel's edge propagation can take a few seconds.
        env:
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          FULL_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          EXPECTED="${FULL_SHA:0:7}"
          URL="${{ steps.deploy.outputs.url }}/api/health"
          echo "Health-checking $URL (expecting sha=$EXPECTED) ..."

          HEADERS_FILE=$(mktemp)
          for i in $(seq 1 12); do
            BODY=$(curl -sf --connect-timeout 5 --max-time 10 -D "$HEADERS_FILE" \
              -H "x-vercel-protection-bypass: $VERCEL_AUTOMATION_BYPASS_SECRET" \
              "$URL" || echo '{}')
            STATUS=$(echo "$BODY" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            if [ "$STATUS" = "ok" ]; then
              DEPLOYED=$(grep -i "^x-commit-sha:" "$HEADERS_FILE" | tr -d '\r' | awk '{print $2}')
              if ! [[ "$DEPLOYED" =~ ^[0-9a-f]{7}$ ]]; then
                rm -f "$HEADERS_FILE"
                echo "::error::Missing or invalid x-commit-sha header (got: '${DEPLOYED}')"
                exit 1
              fi
              if [ "$DEPLOYED" != "$EXPECTED" ]; then
                rm -f "$HEADERS_FILE"
                echo "::error::SHA mismatch — expected $EXPECTED, got $DEPLOYED"
                exit 1
              fi
              rm -f "$HEADERS_FILE"
              echo "  DB reachable, sha=$DEPLOYED — deployment healthy"
              exit 0
            fi
            echo "  status=${STATUS:-unreachable} — retry $i/12 in 10 s..."
            sleep 10
          done
          rm -f "$HEADERS_FILE"
          echo "::error::Health check failed after 2 minutes (last response: $BODY)"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "### Production deployed to ${{ steps.deploy.outputs.url }}" >> "$GITHUB_STEP_SUMMARY"
